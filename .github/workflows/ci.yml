name: CI

on:
  push:
    branches: [ main, feat/*, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install linters
        run: |
          python -m pip install --upgrade pip
          pip install ruff mypy pre-commit
      - name: Run ruff
        run: ruff check .
      - name: Run mypy
        run: mypy .
      - name: Pre-commit (sanity)
        run: pre-commit run --all-files --show-diff-on-failure

  generate-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install tools
        run: |
          python -m pip install --upgrade pip
          pip install copier uv
      - name: Generate sample project with Copier
        env:
          MLCORE_LOCAL_PATH: ci/dummy-mlcore
        run: |
          mkdir -p .sandbox
          copier copy --defaults \
            --data project_name="Sample ML" \
            --data use_prefect=true \
            --data use_pandera=false \
            --data python_version="3.11" \
            . ./.sandbox/sample
      - name: Install sample project
        working-directory: ./.sandbox/sample
        env:
          UV_SYSTEM_PYTHON: "1"
          MLCORE_LOCAL_PATH: "${{ github.workspace }}/ci/dummy-mlcore"
        run: |
          uv pip install -e .
          uv pip install pytest
      - name: Run tests
        working-directory: ./.sandbox/sample
        run: pytest -q
      - name: Dry run flow
        working-directory: ./.sandbox/sample
        run: python -c "from sample_ml.flows.train_eval import train_eval_flow; print(train_eval_flow())"
